# Как работают агенты в Claude Code - Полное руководство

**Дата создания:** 2025-11-03
**Источник:** Беседа с Claude Code

---

## Оглавление
1. [Что такое агенты](#что-такое-агенты)
2. [Как они взаимодействуют](#как-они-взаимодействуют)
3. [Оплата и подписка](#оплата-и-подписка)
4. [Создание своего агента](#создание-своего-агента)
5. [Skills vs Agents](#skills-vs-agents)
6. [Когда использовать агентов](#когда-использовать-агентов)

---

## Что такое агенты

**Агенты = специализированные AI-ассистенты**, которым Claude делегирует задачи.

### Ключевые характеристики:

- **Собственный контекст** - каждый агент работает в своём окне контекста, не засоряя основной диалог
- **Специализация** - настроен на конкретную задачу (code review, debugging, анализ данных)
- **Ограниченные инструменты** - может использовать только определённый набор tools
- **Изолированность** - не видит историю вашего диалога с основным Claude

### Как они хранятся:

```bash
# Личные агенты (доступны во всех проектах)
~/.claude/agents/
  └─ my-analyzer.md

# Проектные агенты (для команды, в git)
.claude/agents/
  └─ project-specific-agent.md
```

---

## Как они взаимодействуют

```
ВЫ (пользователь)
  ↓ запрос
ГЛАВНЫЙ CLAUDE (основной разговор)
  ↓ делегирует через Task tool
SUB-AGENT (специализированный агент)
  ↓ выполняет в своём контексте
  ↓ возвращает результат
ГЛАВНЫЙ CLAUDE
  ↓ показывает результат
ВЫ видите финальный ответ
```

### Практический пример:

```
Вы: "Проанализируй этот CSV файл на дубликаты"

Claude: [запускает data-analyst агента через Task tool]

Агент (в своём контексте):
  1. Read tool → читает CSV
  2. Анализирует данные
  3. Возвращает отчёт основному Claude

Claude → Вы: "Найдено 150 дубликатов, вот детали..."
```

---

## Оплата и подписка

### Важно: Агенты используют ВАШУ подписку Claude

**НЕТ отдельной оплаты за агентов** - все работают через ваш аккаунт!

### Два варианта использования:

#### 1. Claude.ai подписка (рекомендуется):
- Платите за подписку Pro/Team
- Все агенты работают в рамках этой подписки
- Лимиты те же, что в веб-версии Claude

#### 2. Claude Console API (альтернатива):
- Покупаете credits в Anthropic Console
- Каждый вызов агента = API запрос = тратит credits
- Больше контроля, но нужно следить за балансом

### Для каких операций нужны API ключи:

```
✅ НУЖНЫ для внешних сервисов:
   - Apollo API (сбор лидов)
   - Instantly API (email кампании)
   - Hunter.io (валидация email)

❌ НЕ НУЖНЫ для AI обработки:
   - Агент сам является Claude AI
   - Использует вашу подписку автоматически
```

---

## Создание своего агента

### Агент = Markdown файл с YAML frontmatter

```markdown
---
name: "csv-analyzer"
description: "Анализирует CSV файлы на дубликаты и ошибки"
model: "sonnet"  # опционально - какую модель использовать
tools: ["Read", "Grep", "Write"]  # какие инструменты доступны
---

# Инструкции для агента

Ты специалист по анализу CSV файлов.

## Твоя задача:
1. Прочитать файл с помощью Read tool
2. Проверить на дубликаты по email
3. Найти пустые поля
4. Вернуть детальный отчёт

## Правила:
- Всегда используй pandas для анализа
- Отчёт должен быть структурированным
- Указывай количество найденных проблем
```

### Где хранить:

```bash
# Личные агенты (работают во всех проектах)
~/.claude/agents/csv-analyzer.md

# Проектные агенты (для команды, в git)
.claude/agents/csv-analyzer.md
```

### Доступные tools для агентов:

```
Read      - читать файлы
Write     - создавать новые файлы
Edit      - редактировать существующие файлы
Bash      - запускать команды (python, npm, git...)
Glob      - искать файлы по паттерну
Grep      - искать в содержимом файлов
WebFetch  - скачивать данные из интернета
WebSearch - искать в Google
Task      - запускать других агентов (вложенность!)
TodoWrite - создавать todo списки
```

---

## Skills vs Agents

### Agents (субагенты):
- Запускаются явно через Task tool
- Работают в отдельном контексте
- Возвращают результат главному Claude
- Вы контролируете когда они запускаются

**Пример:**
```
Вы: "Используй apollo-lead-collector агента для сбора лидов"
Claude: [запускает агента через Task tool]
```

### Skills (навыки):
- Модульные возможности
- Claude **САМ РЕШАЕТ** когда их использовать
- Работают в основном контексте
- Автоматическая активация на основе описания

**Пример:**
```
У вас есть skill "pdf-processor"
Вы: "Обработай этот PDF"
Claude: [автоматически использует pdf-processor skill, вы не упоминали его]
```

### Ключевая разница:

```
Agent = "Отдельный специалист, которого вызывают для задачи"
Skill = "Дополнительный навык основного Claude"
```

---

## Когда использовать агентов

### ✅ Создавайте агента ЕСЛИ:

1. **Повторяющаяся задача** - будет выполняться каждый день/неделю
2. **Чёткий алгоритм** - шаги не меняются
3. **Нужна изоляция** - не должен мешать основному диалогу
4. **Специализация** - узкая экспертиза в конкретной области
5. **Безопасность** - нужно ограничить возможности (только Read, без Write)
6. **Стабильность результата** - важна повторяемость

### ❌ НЕ создавайте агента ЕСЛИ:

1. **Одноразовая задача** - выполнится один раз
2. **Быстрый анализ** - простой вопрос
3. **Нужен контекст диалога** - решение зависит от предыдущей беседы
4. **Уникальная ситуация** - требуется креативность и адаптация

### Практические примеры:

#### ✅ Хорошо для агента:

```
"Каждый день получаю CSV с лидами из Apollo.
Нужно проверять: дубликаты, пустые поля, формат email, LinkedIn profiles."

→ Создайте агента apollo-csv-validator
```

#### ❌ Не нужен агент:

```
"Вот CSV файл, быстро посчитай сколько компаний из США"

→ Claude сделает напрямую, агент излишен
```

---

## Сравнение качества результатов

### БЕЗ агента (прямой диалог с Claude):

**Плюсы:**
- Видит весь контекст разговора
- Может задавать уточняющие вопросы
- Адаптируется к ситуации
- Креативность и гибкость
- Может сделать больше чем просили (если видит смысл)

**Минусы:**
- Результат может варьироваться
- Нужно повторять инструкции каждый раз
- Может отвлечься на другие темы

**Когда лучше:**
- Первый раз делаете задачу
- Нужна креативность
- Сложный контекст
- Исследовательская работа

---

### С агентом:

**Плюсы:**
- Стабильный результат каждый раз
- Специализированная экспертиза
- Быстрое выполнение (не нужно объяснять)
- Чёткое следование инструкциям
- Изоляция (не мешает основному диалогу)

**Минусы:**
- Не видит контекста диалога
- Меньше креативности
- Только то, что в инструкциях
- Не задаст уточняющих вопросов (если не в промпте)

**Когда лучше:**
- Повторяющаяся задача
- Нужна стабильность
- Чёткий алгоритм
- Автоматизация процесса

---

## Реальный пример из проекта

### Встроенные агенты в Outreach проекте:

```bash
.claude/agents/
├─ apollo-lead-collector.md         # Сбор лидов через Apollo API
├─ apollo-icp-analyzer.md          # Валидация по ICP критериям
├─ instantly-campaign-optimizer.md # Оптимизация email кампаний
└─ cold-outreach-strategist.md     # Стратегии cold outreach
```

### Пример использования:

```
Вы: "Собери 100 лидов из Apollo для AI automation"

Claude:
1. Понимает задачу
2. Запускает apollo-lead-collector агента

Apollo Agent:
3. Читает .env → находит APOLLO_API_KEY
4. Делает API запросы к Apollo
5. Обрабатывает результаты
6. Сохраняет в JSON
7. Возвращает отчёт Claude

Claude:
8. Показывает: "✅ Собрано 100 лидов, сохранено в results/"

Используется:
- Ваша подписка Claude (для AI агента)
- Ваш Apollo API key (для данных)
- НЕ используется отдельный OpenAI API
```

---

## Рекомендации

### Стратегия использования агентов:

1. **Начните без агента** - сделайте задачу первый раз вручную
2. **Оцените повторяемость** - будет ли это делаться снова?
3. **Если да** - создайте агента с инструкциями
4. **Накапливайте библиотеку** - агенты переиспользуют скрипты
5. **Итерируйте** - улучшайте инструкции агента со временем

### Золотое правило:

```
Агент = автоматизация повторяющегося процесса с гарантией качества

Если делаете раз → агент не нужен
Если каждый день → создавайте агента!
```

---

## Дополнительные ресурсы

- [Tools vs Scripts - детальное сравнение](./tools-vs-scripts.md)
- [Стратегии деплоймента агентов](./deployment-strategies.md)
- [MCP серверы для создания новых tools](./mcp-servers-guide.md)

---

**Обновлено:** 2025-11-03
**Статус:** Актуально для Claude Code latest
