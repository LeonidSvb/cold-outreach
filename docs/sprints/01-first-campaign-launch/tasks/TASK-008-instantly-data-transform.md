# TASK-008: Instantly Data Transformation Module

---

## Metadata

```yaml
id: "TASK-008"
title: "Transform Instantly JSON to Supabase RAW Tables Format"
status: "done"
priority: "P1"
labels: ["backend", "instantly", "data-processing"]
dependencies: ["TASK-007"]
created: "2025-10-03"
completed: "2025-10-03"
assignee: "AI Agent"
```

---

## 1. Цель (High-Level Objective)

Создать модуль трансформации JSON данных Instantly в формат для RAW таблиц Supabase с сохранением полного JSON и извлечением ключевых полей.

---

## 2. Контекст (Background)

**Проблема:**
- JSON от Instantly нужно трансформировать для RAW tables
- Таблицы требуют: extracted fields + полный JSON в `raw_json`

**Структура RAW tables:**
- `instantly_campaigns_raw` - campaigns data
- `instantly_accounts_raw` - email accounts
- `instantly_daily_analytics_raw` - daily metrics

---

## 3. Допущения и Ограничения

**ДОПУЩЕНИЯ:**
- TASK-007 завершена (sources module работает)
- Миграция 002 применена (RAW tables exist)

**ОГРАНИЧЕНИЯ:**
- Только RAW layer (normalized позже)
- campaign_id уникальный для campaigns
- email уникальный для accounts

---

## 4. Зависимости

- [ ] TASK-007 (Instantly Sources) завершена
- [ ] Migration 002 (RAW tables) применена в Supabase
- [ ] `migrations/002_instantly_raw_layer.sql` прочитана

---

## 5. Plan Контекста

### В начале:
- `modules/instantly/instantly_sources.py` _(read-only)_
- `migrations/002_instantly_raw_layer.sql` _(read-only для схемы)_

### В конце:
- `modules/instantly/instantly_transform.py`

---

## 6. Пошаговый План

### Шаг 1: Create transform module

**Файл:** `modules/instantly/instantly_transform.py`

```python
#!/usr/bin/env python3
"""
Instantly Data Transformation
Transforms JSON to Supabase RAW tables format
"""

from typing import Dict, Any, List
from datetime import datetime

def transform_campaigns(campaigns: List[Dict]) -> List[Dict[str, Any]]:
    """
    Transform campaigns for instantly_campaigns_raw table

    Schema from 002_instantly_raw_layer.sql:
    - instantly_campaign_id TEXT PRIMARY KEY
    - campaign_name TEXT
    - campaign_status INTEGER
    - leads_count, contacted_count, reply_count, emails_sent_count INTEGER
    - raw_json JSONB NOT NULL
    - synced_at, created_at, updated_at TIMESTAMP
    """
    transformed = []

    for campaign in campaigns:
        row = {
            # Primary key
            "instantly_campaign_id": campaign.get('campaign_id'),

            # Extracted fields for quick queries
            "campaign_name": campaign.get('campaign_name'),
            "campaign_status": campaign.get('campaign_status'),
            "leads_count": campaign.get('leads_count', 0),
            "contacted_count": campaign.get('contacted_count', 0),
            "reply_count": campaign.get('reply_count', 0),
            "emails_sent_count": campaign.get('emails_sent_count', 0),

            # Full JSON (preserves ALL data)
            "raw_json": campaign,

            # Timestamps
            "synced_at": datetime.now().isoformat(),
            "created_at": datetime.now().isoformat(),
            "updated_at": datetime.now().isoformat()
        }

        transformed.append(row)

    return transformed

def transform_accounts(accounts: List[Dict]) -> List[Dict[str, Any]]:
    """
    Transform accounts for instantly_accounts_raw table

    Schema:
    - email TEXT PRIMARY KEY
    - first_name, last_name TEXT
    - account_status, warmup_status, warmup_score INTEGER
    - raw_json JSONB NOT NULL
    - synced_at, created_at, updated_at TIMESTAMP
    """
    transformed = []

    for account in accounts:
        row = {
            # Primary key
            "email": account.get('email'),

            # Extracted fields
            "first_name": account.get('first_name'),
            "last_name": account.get('last_name'),
            "account_status": account.get('status'),
            "warmup_status": account.get('warmup_status'),
            "warmup_score": account.get('stat_warmup_score'),

            # Full JSON
            "raw_json": account,

            # Timestamps
            "synced_at": datetime.now().isoformat(),
            "created_at": datetime.now().isoformat(),
            "updated_at": datetime.now().isoformat()
        }

        transformed.append(row)

    return transformed

def transform_daily_analytics(daily: List[Dict],
                              campaign_id: str = None) -> List[Dict[str, Any]]:
    """
    Transform daily analytics for instantly_daily_analytics_raw table

    Schema:
    - id UUID PRIMARY KEY (generated by Supabase)
    - analytics_date DATE NOT NULL
    - instantly_campaign_id TEXT (optional)
    - sent, opened, unique_opened, replies, etc. INTEGER
    - raw_json JSONB NOT NULL
    """
    transformed = []

    for record in daily:
        row = {
            # Date identification
            "analytics_date": record.get('date'),

            # Optional campaign link
            "instantly_campaign_id": campaign_id,

            # Extracted metrics
            "sent": record.get('sent', 0),
            "opened": record.get('opened', 0),
            "unique_opened": record.get('unique_opened', 0),
            "replies": record.get('replies', 0),
            "unique_replies": record.get('unique_replies', 0),
            "clicks": record.get('clicks', 0),
            "unique_clicks": record.get('unique_clicks', 0),

            # Full JSON
            "raw_json": record,

            # Timestamps
            "synced_at": datetime.now().isoformat(),
            "created_at": datetime.now().isoformat()
        }

        transformed.append(row)

    return transformed

def validate_transformed_data(table: str, rows: List[Dict]) -> Dict[str, Any]:
    """
    Validate transformed data before upload

    Args:
        table: Table name
        rows: Transformed rows

    Returns:
        Dict with validation result
    """
    if not rows:
        return {
            "valid": False,
            "error": "No rows to validate"
        }

    # Check required fields based on table
    required_fields = {
        "instantly_campaigns_raw": ["instantly_campaign_id", "raw_json"],
        "instantly_accounts_raw": ["email", "raw_json"],
        "instantly_daily_analytics_raw": ["analytics_date", "raw_json"]
    }

    if table not in required_fields:
        return {
            "valid": False,
            "error": f"Unknown table: {table}"
        }

    # Validate each row has required fields
    for i, row in enumerate(rows):
        for field in required_fields[table]:
            if field not in row or row[field] is None:
                return {
                    "valid": False,
                    "error": f"Row {i}: missing required field '{field}'"
                }

    return {
        "valid": True,
        "rows_validated": len(rows)
    }

# Test function
if __name__ == "__main__":
    # Test transform functions
    test_campaign = {
        "campaign_id": "test-123",
        "campaign_name": "Test Campaign",
        "campaign_status": 2,
        "leads_count": 100,
        "contacted_count": 50,
        "reply_count": 5,
        "emails_sent_count": 75
    }

    result = transform_campaigns([test_campaign])
    print(f"Transformed campaigns: {len(result)}")
    print(f"Sample: {result[0]['instantly_campaign_id']}")

    # Validate
    validation = validate_transformed_data("instantly_campaigns_raw", result)
    print(f"Validation: {validation}")
```

### Шаг 2: Test transformation

**Команда:**
```bash
cd modules/instantly
python instantly_transform.py
```

**Expected:**
```
Transformed campaigns: 1
Sample: test-123
Validation: {'valid': True, 'rows_validated': 1}
```

---

## 7. Критерии Приёмки

- [x] `modules/instantly/instantly_transform.py` создан
- [x] `transform_campaigns()` возвращает правильный формат
- [x] `transform_accounts()` работает
- [x] `transform_daily_analytics()` работает
- [x] `validate_transformed_data()` проверяет required fields
- [x] `raw_json` содержит полный JSON object
- [x] Test script проходит (ALL TESTS PASSED)

---

## 8. Стратегия Тестирования

**Integration test with real data:**
```python
from instantly_sources import load_from_json, extract_campaigns
from instantly_transform import transform_campaigns, validate_transformed_data

# Load real data
result = load_from_json('results/raw_data_20250921_125555.json')
campaigns = extract_campaigns(result['data'])

# Transform
transformed = transform_campaigns(campaigns)

# Validate
validation = validate_transformed_data('instantly_campaigns_raw', transformed)

assert validation['valid'] == True
assert len(transformed) == 4  # 4 campaigns in test data
```

---

## 9. Результаты Тестирования

**Дата:** 2025-10-03

**Unit Test:**
```
Transformed campaigns: 1
Sample: test-123
Validation: {'valid': True, 'rows_validated': 1}
```

**Integration Test (Real Data):**
```
Data type: raw_data
Campaigns extracted: 4
Campaigns transformed: 4
Validation: {'valid': True, 'rows_validated': 4}

Accounts extracted: 10
Accounts transformed: 10
Validation: {'valid': True, 'rows_validated': 10}

Daily records extracted: 17
Daily records transformed: 17
Validation: {'valid': True, 'rows_validated': 17}

INTEGRATION TEST SUMMARY:
Campaigns: PASS
Accounts: PASS
Daily Analytics: PASS
ALL TESTS PASSED
```

**Созданные файлы:**
- `modules/instantly/instantly_transform.py` - основной модуль трансформации
- `modules/instantly/test_transform_integration.py` - integration test

**Ключевые исправления:**
- Использование правильных field names: `campaign_id` вместо `id`, `campaign_name` вместо `name`
- Все 3 функции трансформации работают корректно
- Валидация required fields проходит

---

**Task Version:** 1.0
